# Ferris Mark DX

A Windows DirectX 11 2D sprite rendering benchmark written in Rust, inspired by [gophermark](https://github.com/unitoftime/experiments/tree/master/gophermark).

This experiment was written by Claude Sonnet 4. We got a prototype up and running to better understand the necessary components for future DirectX 11 projects.

The [Ferris](https://www.rustacean.net/) sprite was generated by OpenAI ChatGPT, and modified slightly in [Aseprite](https://www.aseprite.org/).

## Features

- **2D Sprite Rendering**: Multiple bouncing sprites with edge collision detection
- **Performance Benchmarking**: Sprites-per-second throughput measurement
- **DirectX 11 Hardware Acceleration**: GPU rendering pipeline
- **Point Filtering**: Nearest neighbor sampling for crisp pixel art
- **Configurable Sprite Count**: Command-line argument for testing different loads
- **VSync Support**: ~60 FPS rendering
- **Debug Layer Integration**: DirectX validation

### TODOs

Turning this into a more useful reusable library will likely be a separate project.

- Full-screen toggle (Alt-Enter)
- Switch rendering to have a logical resolution (e.g. 640x360) with scaling and aspect ratio preservation
- Refactor to extract DirectX code into a library and provide a safe abstraction
- Sprite Batching, likely derived from [DirectXTK](https://github.com/microsoft/DirectXTK/)
- Consider `raw-window-handle`
- [PIX](https://learn.microsoft.com/en-us/windows/win32/direct3dtools/pix/pix-overview) for debugging
- Debug layer logging doesn't output to console (may need to attach a debugger)
- Utilize existing benchmarking tools for frame times, etc.

## Building and Running

### Basic Usage
```bash
# Run with default 100 sprites
cargo run

# Run with specific sprite count
cargo run 500
cargo run 1000
cargo run 5000
```

## Controls

- **Close Window**: Click X button or press Alt+F4
- **Resize**: Drag window edges (DirectX swap chain automatically resizes)

### Build Variants
```bash
# Debug Build (with DirectX debug layer)
cargo run

# Release Build (optimized, no debug layer)
cargo run --release

# Release Build with Debug Layer
cargo run --release --features d3d11-debug
```

### Benchmarking
The application accepts a sprite count as the first command-line argument:
```bash
cargo run 100      # 100 sprites
cargo run 500      # 500 sprites
cargo run 1000     # 1000 sprites
cargo run 5000     # 5000 sprites

cargo run --release 100000
```

Performance metrics are displayed every second:
```
Sprites/sec: 6000000 | FPS: 60.0 | Sprites: 100000 | Frame time: 16.67ms
```

- **Sprites/sec**: Primary benchmark metric - total sprite throughput
- **FPS**: Frames per second (capped at 60 with VSync)
- **Sprites**: Current number of active sprites
- **Frame time**: Time per frame in milliseconds

### Benchmark Sample Results

Results running on a Ryzen 9700X and Radeon 9070 XT running driver version 25.6.1:

* Unbatched debug build: rendering 11,000 sprites at 60 fps, 660,000 sprites/second, frame dips
* Unbatched release build: rendering 100,000 sprites at 60 fps, near 6,000,000 sprites/second, frame dips

## Development

### Dependencies

- `windows` crate for Win32 and DirectX 11 APIs
- `image` crate for PNG texture loading
- Rust edition 2024

### DirectX 11 Debug Layer

The application supports DirectX 11 debug layer validation which provides:
- API usage validation
- Additional error checking and warnings
- Performance analysis information
- Memory leak detection

#### Debug Layer Modes

1. **Automatic (recommended)**: Debug layer is enabled in debug builds, disabled in release builds
2. **Manual**: Use the `d3d11-debug` feature flag to explicitly enable the debug layer

#### Requirements for Debug Layer

The DirectX 11 debug layer requires the "Graphics Tools" Windows optional feature to be installed:
- Windows 10/11: Settings > Apps > Optional features > Add a feature > Graphics Tools
- Or install via PowerShell: `Enable-WindowsOptionalFeature -Online -FeatureName "DirectX-Tools"`

#### Where Debug Messages Appear

DirectX debug messages typically appear in:
- **Visual Studio Output Window**: When running under the debugger
- **Windows Event Log**: Application and Services Logs > Microsoft > Windows > Direct3D11
- **Debug Output Stream**: Captured by debugging tools like PIX or Visual Studio Graphics Diagnostics

Note: Debug messages usually don't appear in the console when running standalone applications. The application will show "Debug Layer: ENABLED" to confirm the debug layer is active and capturing validation messages.
